# /root/pdf/nginx_conf.conf
worker_processes  1;

events { worker_connections 1024; }

http {
    # ---------- 后端 Anvil ----------
    upstream anvil {
        server 127.0.0.1:8443;
    }
    # ---------- HTTPS 主站 ----------
    server {
    listen 443 ssl default_server;  # 只有这一条
    server_name l4proxy.top;

    ssl_certificate     /etc/letsencrypt/live/l4proxy.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/l4proxy.top/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;

    # 统一的头
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    # 首页
    location = /        { proxy_pass http://anvil; }

    # Anvil API & WebSocket
    location ^~ /_/ {
        proxy_pass http://anvil;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 其他全部丢弃
    location / { return 444; }
}

}
